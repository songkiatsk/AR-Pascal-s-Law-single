<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Hydraulic pipe – AR (F1, A1, A2, P, F2)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <!-- A-Frame & AR.js CDN -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <style>
    html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,TH Sarabun New,Arial}
    .hud{position:fixed;left:8px;right:8px;bottom:8px;z-index:5;
         background:rgba(20,22,25,.7);backdrop-filter:blur(6px);
         color:#fff;border-radius:14px;padding:10px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>div{display:flex;gap:6px;align-items:center}
    input[type=range]{width:140px}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid #666;background:#2b2f36;color:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .kpi{font-variant-numeric:tabular-nums}
    .formula{position:fixed;top:8px;left:8px;z-index:5;background:rgba(255,255,255,.9);color:#111;
             padding:10px 12px;border-radius:12px;display:none;max-width:92vw}
    .formula code{background:#f1f3f5;padding:2px 6px;border-radius:8px}
    .badge{position:fixed;top:8px;right:8px;z-index:5;background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:999px;font-weight:600}
    .small{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="badge">Hydraulic pipe</div>

  <!-- Formula panel -->
  <div id="formula" class="formula">
    <div><strong>สูตรสำคัญ</strong></div>
    <div class="small">กฎของพาสคัล: แรงดันส่งผ่านเท่ากันทั่วของเหลว</div>
    <div style="margin-top:6px">
      <div><code>P = F/A</code></div>
      <div><code>F₂ = P·A₂ = F₁·(A₂/A₁)</code></div>
      <div><code>Δy₂ = Δy₁·(A₁/A₂)</code> (อนุรักษ์ปริมาตร)</div>
    </div>
  </div>

  <!-- AR Scene -->
  <a-scene
    embedded
    renderer="antialias:true;colorManagement:true"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
    <a-assets></a-assets>

    <!-- Marker (ใช้ hiro; บน MyWebAR เปลี่ยนเป็น marker ของครูได้) -->
    <a-marker preset="hiro">
      <!-- พื้นอ้างอิง -->
      <a-plane rotation="-90 0 0" width="2" height="2" color="#e5e7eb" position="0 0 0"></a-plane>

      <!-- ป้ายชื่อ -->
      <a-entity position="0 0.15 0.7" rotation="-90 0 0">
        <a-text value="Hydraulic pipe" align="center" width="2.2" color="#111"></a-text>
      </a-entity>

      <!-- ชุดท่อ U เชื่อมถึงกัน (กระบอกซ้าย-ขวา) -->
      <a-entity id="rig" position="0 0.02 0">
        <!-- กระบอกเล็ก (ซ้าย) -->
        <a-cylinder id="cylSmall" position="-0.35 0.12 0" radius="0.07" height="0.24" color="#cbd5e1"></a-cylinder>
        <!-- กระบอกใหญ่ (ขวา) -->
        <a-cylinder id="cylLarge" position="0.35 0.16 0" radius="0.12" height="0.32" color="#cbd5e1"></a-cylinder>

        <!-- ท่อฐานเชื่อม -->
        <a-box position="0 0.02 0" depth="0.12" width="0.7" height="0.04" color="#cbd5e1"></a-box>

        <!-- ของเหลว (น้ำสีฟ้า) -->
        <a-entity id="fluid">
          <!-- ฐานท่อ -->
          <a-box id="fluidBase" position="0 0.04 0" depth="0.10" width="0.68" height="0.035" color="#60a5fa" opacity="0.85"></a-box>
          <!-- แขนซ้ายขึ้นในกระบอกเล็ก -->
          <a-box id="fluidLeft" position="-0.35 0.08 0" depth="0.10" width="0.12" height="0.12" color="#60a5fa" opacity="0.85"></a-box>
          <!-- แขนขวาขึ้นในกระบอกใหญ่ -->
          <a-box id="fluidRight" position="0.35 0.10 0" depth="0.10" width="0.20" height="0.16" color="#60a5fa" opacity="0.85"></a-box>
        </a-entity>

        <!-- ลูกสูบเล็ก -->
        <a-cylinder id="pistonSmall" position="-0.35 0.24 0" radius="0.071" height="0.015" color="#111827"></a-cylinder>
        <!-- ลูกศรแรงบนลูกสูบเล็ก -->
        <a-entity id="arrow" position="-0.35 0.32 0" rotation="-90 0 0">
          <a-cone radius-bottom="0.02" radius-top="0" height="0.06" color="#ef4444" position="0 0.03 0"></a-cone>
          <a-cylinder radius="0.007" height="0.10" color="#ef4444" position="0 0.10 0"></a-cylinder>
        </a-entity>

        <!-- ลูกสูบใหญ่ -->
        <a-cylinder id="pistonLarge" position="0.35 0.30 0" radius="0.121" height="0.015" color="#111827"></a-cylinder>
      </a-entity>

      <!-- กล้องของ marker -->
      <a-entity camera></a-entity>
    </a-marker>

    <!-- กล้อง fallback -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- HUD Controls -->
  <div class="hud">
    <div class="row">
      <div><label>F1 (N)</label><input id="f1" type="range" min="0" max="300" step="1" value="100"><span id="f1v" class="kpi">100</span></div>
      <div><label>A1 (cm²)</label><input id="a1" type="range" min="1" max="12" step="0.5" value="3"><span id="a1v" class="kpi">3.0</span></div>
      <div><label>A2 (cm²)</label><input id="a2" type="range" min="5" max="120" step="1" value="40"><span id="a2v" class="kpi">40</span></div>
      <div class="kpi">P = <span id="pv">33.33</span> N/cm²</div>
      <div class="kpi">F₂ = <span id="f2v">1333</span> N</div>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="toggleFormula" class="btn">Show Formula</button>
      <button id="resetBtn" class="btn">Reset</button>
      <button id="wireBtn" class="btn">Toggle Wireframe</button>
      <span class="small">* ลูกศรมี “ล็อกขั้นต่ำ” ไม่ให้จมทะลุลูกสูบ</span>
    </div>
  </div>

  <script>
    // UI elements
    const f1 = document.getElementById('f1');
    const a1 = document.getElementById('a1');
    const a2 = document.getElementById('a2');
    const f1v = document.getElementById('f1v');
    const a1v = document.getElementById('a1v');
    const a2v = document.getElementById('a2v');
    const pv  = document.getElementById('pv');
    const f2v = document.getElementById('f2v');
    const formula = document.getElementById('formula');
    const toggleFormula = document.getElementById('toggleFormula');
    const resetBtn = document.getElementById('resetBtn');
    const wireBtn = document.getElementById('wireBtn');

    // 3D entities
    const pistonSmall = () => document.querySelector('#pistonSmall');
    const pistonLarge = () => document.querySelector('#pistonLarge');
    const fluidLeft   = () => document.querySelector('#fluidLeft');
    const fluidRight  = () => document.querySelector('#fluidRight');
    const arrow       = () => document.querySelector('#arrow');
    const shellParts  = ['#cylSmall','#cylLarge','a-box[width="0.7"]'].map(q=>document.querySelector(q));

    // Base positions (meters in A-Frame units)
    const base = {
      ySmall: 0.24,
      yLarge: 0.30,
      fluidLeftY: 0.08,
      fluidRightY: 0.10,
      arrowYmin: 0.28, // lock-min above small piston
      arrowY0: 0.32
    };

    function update() {
      const F1 = Number(f1.value);
      const A1 = Number(a1.value); // cm^2
      const A2 = Number(a2.value); // cm^2

      // Display values
      f1v.textContent = F1.toFixed(0);
      a1v.textContent = A1.toFixed(1);
      a2v.textContent = A2.toFixed(0);

      // Physics (scaled for visualization)
      const P = (A1>0)? (F1/A1) : 0;          // N/cm^2
      const F2 = P * A2;                      // N
      pv.textContent  = P.toFixed(2);
      f2v.textContent = Math.round(F2);

      // Visual displacement (arbitrary scale that looks good in AR)
      // small piston down ~ proportional to F1 and inversely to A1
      const dy1 = Math.min(0.08, F1/(A1*900));     // <= 8 cm in scene
      const dy2 = dy1 * (A1/A2);                   // large piston up

      // Update pistons
      const ySmall = base.ySmall - dy1;
      const yLarge = base.yLarge + dy2;
      pistonSmall().setAttribute('position', {x:-0.35, y:ySmall, z:0});
      pistonLarge().setAttribute('position', {x: 0.35, y:yLarge, z:0});

      // Update fluid columns (keep top faces near pistons)
      fluidLeft().setAttribute('position',  {x:-0.35, y: base.fluidLeftY - dy1/2, z:0});
      fluidLeft().setAttribute('height',    0.12 - dy1);

      fluidRight().setAttribute('position', {x: 0.35, y: base.fluidRightY + dy2/2, z:0});
      fluidRight().setAttribute('height',   0.16 + dy2);

      // Arrow lock-min just above piston
      const yArrow = Math.max(base.arrowYmin, base.arrowY0 - dy1*1.25);
      arrow().setAttribute('position', {x:-0.35, y:yArrow, z:0});
    }

    // Wireframe toggle
    let wired = false;
    function toggleWire() {
      wired = !wired;
      // cylinders
      ['#cylSmall','#cylLarge','#pistonSmall','#pistonLarge'].forEach(q=>{
        const el = document.querySelector(q);
        const mat = el.getObject3D('mesh')?.material;
        if(mat){ mat.wireframe = wired; }
        el.addEventListener('model-loaded', ()=>{
          const m = el.getObject3D('mesh')?.material;
          if(m) m.wireframe = wired;
        });
      });
      // boxes (shell & fluid)
      document.querySelectorAll('a-box').forEach(el=>{
        const mat = el.getObject3D('mesh')?.material;
        if(mat){ mat.wireframe = wired; }
      });
    }

    // Events
    [f1,a1,a2].forEach(el => el.addEventListener('input', update));
    toggleFormula.addEventListener('click', ()=>{
      const show = formula.style.display !== 'block';
      formula.style.display = show ? 'block':'none';
      toggleFormula.textContent = show ? 'Hide Formula':'Show Formula';
    });
    resetBtn.addEventListener('click', ()=>{
      f1.value = 100; a1.value=3; a2.value=40;
      update();
    });
    wireBtn.addEventListener('click', toggleWire);

    // Kickoff
    window.addEventListener('load', ()=>{ update(); });
  </script>
</body>
</html>

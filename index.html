<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Pascal ‚Äî Single File (Mobile Fix)</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    :root { --panel: rgba(0,0,0,.84); --border: rgba(255,255,255,.12); --accent:#fbbf24; }
    *{box-sizing:border-box}
    body{margin:0;overflow:hidden;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
         font-family:'Noto Sans Thai',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #ar-scene{position:fixed;inset:0;z-index:1}
    .ui{position:fixed;inset:0;z-index:5;pointer-events:none}
    .panel{pointer-events:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .info{position:absolute;left:12px;right:12px;top:12px;padding:10px}
    .ctrl{position:absolute;left:12px;right:12px;bottom:12px;padding:12px;transition:transform .25s ease, opacity .25s ease}
    .row{margin:8px 0}
    .label{font-weight:700;color:var(--accent);margin-bottom:4px;display:block}
    .sliderrow{display:flex;gap:10px;align-items:center}
    input[type="range"]{flex:1;appearance:none;height:8px;border-radius:6px;background:linear-gradient(90deg,#3b82f6,#8b5cf6);outline:none}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.35);cursor:pointer}
    .val{min-width:70px;text-align:center;background:rgba(255,255,255,.08);padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px}
    .calc{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.35);border-radius:10px;padding:8px;margin-top:6px}
    .calc .line{display:flex;justify-content:space-between;margin:3px 0;font-family:ui-monospace,Consolas,Menlo,monospace}
    .fab{position:absolute;right:12px;bottom:12px;z-index:6;pointer-events:auto;background:#111827;border:1px solid var(--border);
         width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.38)}
    .lang{position:absolute;top:12px;right:12px;background:var(--panel);border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;pointer-events:auto;font-size:12px}
    .hint{opacity:.9;font-size:12px;margin-top:4px}
    .hidden{opacity:0;transform:translateY(8px);pointer-events:none}
    .truncate{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    @media(min-width:900px){
      .info,.ctrl{left:24px;right:auto;width:380px}
      .lang{top:16px;right:16px}
      .fab{right:16px;bottom:16px}
      .info{top:16px}.ctrl{bottom:16px}
    }
  </style>
</head>
<body>
  <button class="lang" id="langBtn" onclick="toggleLang()">üá¨üáß English</button>
  <button class="fab" id="toggleBtn" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">‚öôÔ∏è</button>

  <div class="ui">
    <div class="panel info">
      <h3 id="title" style="margin:0 0 4px 0;font-size:16px">‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏õ‡∏≤‡∏™‡∏Ñ‡∏≤‡∏• (AR)</h3>
      <div id="desc" class="truncate" style="font-size:13px">‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Å‡∏±‡∏ö‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏ö‡∏ô‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà</div>
      <div class="hint" id="hint">üì± ‡∏ä‡∏µ‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà AR marker (HIRO) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
    </div>

    <div class="panel ctrl" id="ctrlPanel">
      <div class="row">
        <label class="label" id="lblF1">‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (F‚ÇÅ)</label>
        <div class="sliderrow">
          <input type="range" id="F1" min="10" max="200" step="5" value="60">
          <div class="val" id="F1v">60 N</div>
        </div>
      </div>
      <div class="row">
        <label class="label" id="lblA1">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å (A‚ÇÅ)</label>
        <div class="sliderrow">
          <input type="range" id="A1" min="0.10" max="0.50" step="0.01" value="0.28">
          <div class="val" id="A1v">0.28 m¬≤</div>
        </div>
      </div>
      <div class="row">
        <label class="label" id="lblA2">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà (A‚ÇÇ)</label>
        <div class="sliderrow">
          <input type="range" id="A2" min="0.50" max="2.00" step="0.01" value="1.13">
          <div class="val" id="A2v">1.13 m¬≤</div>
        </div>
      </div>
      <div class="calc">
        <div class="line"><span id="lblP">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (P):</span><span id="vP">‚Äî</span></div>
        <div class="line"><span id="lblF2">‡πÅ‡∏£‡∏á‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (F‚ÇÇ):</span><span id="vF2">‚Äî</span></div>
        <div class="line"><span id="lblMA">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏• (MA):</span><span id="vMA">‚Äî</span></div>
      </div>
    </div>
  </div>

  <a-scene id="ar-scene" embedded renderer="antialias:true; colorManagement:true; sortObjects:true"
           arjs="sourceType: webcam; debugUIEnabled:false; patternRatio:0.8; trackingMethod: best"
           vr-mode-ui="enabled:false" loading-screen="enabled:false">
    <a-marker preset="hiro" id="marker" smooth="true" smoothCount="7" smoothTolerance="0.01" smoothThreshold="10">
      <a-entity id="rig" position="0 0 0" scale="0.35 0.35 0.35">
        <!-- Base -->
        <a-box position="0 -0.3 0" width="2" height="0.08" depth="1.2" color="#374151"></a-box>

        <!-- Left (small) -->
        <a-entity id="left" position="-0.75 0 0">
          <a-cylinder id="leftWall" radius="0.25" height="1.2" color="#3b82f6"></a-cylinder>
          <a-cylinder id="leftPiston" position="0 -0.2 0" radius="0.235" height="0.1" color="#fbbf24"></a-cylinder>
          <a-cylinder id="leftFluid"  position="0 -0.5 0" radius="0.22"  height="0.65" color="#06b6d4" opacity="0.7"></a-cylinder>
          <!-- Arrow sits ABOVE piston, scales with F1; never penetrates -->
          <a-cone id="arrow" position="0 0.5 0" radius-bottom="0.08" radius-top="0" height="0.22" color="#ef4444" rotation="0 0 180"></a-cone>
        </a-entity>

        <!-- Right (large) -->
        <a-entity id="right" position="0.75 0 0">
          <a-cylinder id="rightWall" radius="0.45" height="1.2" color="#3b82f6"></a-cylinder>
          <a-cylinder id="rightPiston" position="0 -0.2 0" radius="0.43" height="0.1" color="#fbbf24"></a-cylinder>
          <a-cylinder id="rightFluid"  position="0 -0.5 0" radius="0.40" height="0.65" color="#06b6d4" opacity="0.7"></a-cylinder>
          <a-box id="load" position="0 0.45 0" width="0.6" height="0.25" depth="0.6" color="#7c3aed"></a-box>
        </a-entity>

        <!-- Pipe -->
        <a-cylinder position="0 -0.65 0" radius="0.04" height="1.5" rotation="0 0 90" color="#6b7280"></a-cylinder>

        <!-- Labels -->
        <a-text position="-0.75 -1.0 0" value="Small Piston\n‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å" align="center" color="#fbbf24" scale="0.45 0.45 0.45"></a-text>
        <a-text position="0.75 -1.0 0" value="Large Piston\n‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà" align="center" color="#fbbf24" scale="0.45 0.45 0.45"></a-text>
      </a-entity>
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="2 4 2" color="#ffffff" intensity="1"></a-light>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // State
    let lang = 'th';
    const state = { F1:60, A1:0.28, A2:1.13, arReady:false };

    // Helpers
    const el = id => document.getElementById(id);
    const clamp = (v,mi,ma)=>Math.min(ma,Math.max(mi,v));
    const rFromArea = A => Math.sqrt(A/Math.PI);

    // Texts
    const T = {
      th:{title:"‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏õ‡∏≤‡∏™‡∏Ñ‡∏≤‡∏• (AR)",
          desc:"‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Å‡∏±‡∏ö‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏ö‡∏ô‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà",
          hint:"üì± ‡∏ä‡∏µ‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà AR marker (HIRO) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°",
          lblF1:"‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (F‚ÇÅ)", lblA1:"‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å (A‚ÇÅ)", lblA2:"‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏™‡∏ï‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà (A‚ÇÇ)",
          lblP:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (P):", lblF2:"‡πÅ‡∏£‡∏á‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (F‚ÇÇ):", lblMA:"‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏• (MA):", langBtn:"üá¨üáß English"},
      en:{title:"Pascal's Law (AR)",
          desc:"Adjust the force on the small piston and observe pressure transmission through the fluid creating a larger force on the big piston.",
          hint:"üì± Point your camera at the HIRO AR marker to start",
          lblF1:"Applied Force (F‚ÇÅ)", lblA1:"Small Piston Area (A‚ÇÅ)", lblA2:"Large Piston Area (A‚ÇÇ)",
          lblP:"Pressure (P):", lblF2:"Output Force (F‚ÇÇ):", lblMA:"Mechanical Advantage (MA):", langBtn:"üáπüá≠ ‡πÑ‡∏ó‡∏¢"}
    };

    function applyTexts(){
      const t = T[lang];
      el('title').textContent = t.title;
      el('desc').textContent = t.desc;
      el('hint').textContent = t.hint;
      el('lblF1').textContent = t.lblF1;
      el('lblA1').textContent = t.lblA1;
      el('lblA2').textContent = t.lblA2;
      el('lblP').textContent  = t.lblP;
      el('lblF2').textContent = t.lblF2;
      el('lblMA').textContent = t.lblMA;
      el('langBtn').textContent = t.langBtn;
    }

    function updateUI(){
      const P  = state.F1 / state.A1;
      const F2 = P * state.A2;
      const MA = state.A2 / state.A1;
      el('F1v').textContent = `${state.F1} N`;
      el('A1v').textContent = `${state.A1.toFixed(2)} m¬≤`;
      el('A2v').textContent = `${state.A2.toFixed(2)} m¬≤`;
      el('vP').textContent  = `P = ${state.F1} √∑ ${state.A1.toFixed(2)} = ${P.toFixed(0)} Pa`;
      el('vF2').textContent = `F‚ÇÇ = ${P.toFixed(0)} √ó ${state.A2.toFixed(2)} = ${F2.toFixed(0)} N`;
      el('vMA').textContent = `MA = ${state.A2.toFixed(2)} √∑ ${state.A1.toFixed(2)} = ${MA.toFixed(1)}√ó`;
    }

    function updateRadii(){
      if (!state.arReady) return;
      const rS = rFromArea(state.A1);
      const rL = rFromArea(state.A2);
      el('leftWall').setAttribute('radius', rS);
      el('leftPiston').setAttribute('radius', rS*0.94);
      el('leftFluid').setAttribute('radius', rS*0.88);
      el('rightWall').setAttribute('radius', rL);
      el('rightPiston').setAttribute('radius', rL*0.94);
      el('rightFluid').setAttribute('radius', rL*0.88);
    }

    function updatePositions(){
      if (!state.arReady) return;
      const P  = state.F1 / state.A1;
      const F2 = P * state.A2;

      // Geometry bounds
      const halfCyl = 1.2/2;       // 0.6
      const halfP   = 0.1/2;       // 0.05
      const minY = -halfCyl + halfP;   // -0.55
      const maxY =  halfCyl - halfP;   //  +0.55

      // Tuned mapping with safe clamps
      const yL = clamp(-0.2 - (state.F1/1000), minY, maxY);
      const yR = clamp(-0.2 + (F2/2200),      minY, maxY);

      el('leftPiston').setAttribute('position',`0 ${yL} 0`);
      el('rightPiston').setAttribute('position',`0 ${yR} 0`);
      el('leftFluid').setAttribute('position', `0 ${yL - 0.3} 0`);
      el('rightFluid').setAttribute('position',`0 ${yR - 0.3} 0`);
      el('load').setAttribute('position', `0 ${yR + 0.3} 0`);

      // Arrow: above piston, scales with F1 (no penetration)
      const safetyGap = 0.06;
      const arrowH = 0.18 + (state.F1/600);  // increases with F1
      const arrowCenterY = yL + halfP + safetyGap + (arrowH/2);
      const arrowMaxCenter = maxY + 0.15;
      const finalY = Math.min(arrowCenterY, arrowMaxCenter);
      const arrow = el('arrow');
      arrow.setAttribute('height', arrowH.toFixed(3));
      arrow.setAttribute('position', `0 ${finalY.toFixed(3)} 0`);
    }

    function bindUI(){
      el('F1').addEventListener('input', e=>{ state.F1 = parseFloat(e.target.value); updateUI(); updatePositions(); });
      el('A1').addEventListener('input', e=>{ state.A1 = parseFloat(e.target.value); updateUI(); updateRadii(); updatePositions(); });
      el('A2').addEventListener('input', e=>{ state.A2 = parseFloat(e.target.value); updateUI(); updateRadii(); updatePositions(); });

      // Floating toggle for compact UI
      const ctrl = el('ctrlPanel');
      const tog  = el('toggleBtn');
      const hide = ()=> ctrl.classList.add('hidden');
      const show = ()=> ctrl.classList.remove('hidden');
      tog.addEventListener('click', ()=> ctrl.classList.toggle('hidden'));
      const isPhone = Math.min(window.innerWidth, window.innerHeight) <= 480;
      if (isPhone) hide(); else show();
    }

    function handleMarker(){
      const marker = el('marker');
      marker.addEventListener('markerFound', ()=>{
        state.arReady = true; updateRadii(); updatePositions();
        const isPhone = Math.min(window.innerWidth, window.innerHeight) <= 480;
        if (isPhone){ el('desc').classList.add('truncate'); el('hint').style.display='none'; }
      });
      marker.addEventListener('markerLost', ()=>{ state.arReady = false; });
    }

    function toggleLang(){ lang = (lang==='th')?'en':'th'; applyTexts(); updateUI(); }

    document.addEventListener('DOMContentLoaded', ()=>{
      applyTexts(); updateUI(); bindUI(); handleMarker();
    });
  </script>
</body>
</html>
